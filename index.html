<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Typing conformance</title>
    <meta name="color-scheme" content="dark light" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      html[data-theme="light"] {
        color-scheme: light;
      }

      /* Make native title tooltips discoverable via a consistent visual hint. */
      .has-tooltip {
        text-decoration: underline dotted;
        text-underline-offset: 3px;
        cursor: help;
      }
      .tooltip-icon {
        display: inline-block;
        margin-left: 0.35rem;
        font-weight: 700;
        opacity: 0.8;
        cursor: help;
      }

      .col-highlight {
        background-color: rgba(15, 23, 42, 0.35);
      }
      .row-highlight {
        background-color: rgba(30, 41, 59, 0.35);
      }
      .cell-highlight {
        color: #f8fafc;
      }
      .head-highlight {
        color: #bae6fd;
      }

      html[data-theme="light"] body {
        background-color: #f8fafc !important;
        color: #0f172a !important;
      }

      html[data-theme="light"] .text-slate-100 {
        color: #0f172a !important;
      }
      html[data-theme="light"] .text-slate-200 {
        color: #1e293b !important;
      }
      html[data-theme="light"] .text-slate-300 {
        color: #334155 !important;
      }
      html[data-theme="light"] .text-slate-400,
      html[data-theme="light"] .text-slate-500 {
        color: #475569 !important;
      }

      html[data-theme="light"] .bg-slate-900\/40,
      html[data-theme="light"] .bg-slate-900\/60 {
        background-color: rgba(255, 255, 255, 0.92) !important;
      }
      html[data-theme="light"] .bg-slate-950\/50 {
        background-color: rgba(241, 245, 249, 0.9) !important;
      }
      html[data-theme="light"] .bg-slate-800,
      html[data-theme="light"] .bg-slate-800\/40 {
        background-color: rgba(226, 232, 240, 0.8) !important;
      }

      html[data-theme="light"] .ring-slate-800,
      html[data-theme="light"] .ring-slate-700 {
        --tw-ring-color: #cbd5e1 !important;
      }
      html[data-theme="light"] .border-slate-800,
      html[data-theme="light"] .border-slate-900\/60 {
        border-color: #e2e8f0 !important;
      }

      html[data-theme="light"] .text-sky-300,
      html[data-theme="light"] .text-sky-200 {
        color: #2563eb !important;
      }
      html[data-theme="light"] .hover\:text-sky-200:hover,
      html[data-theme="light"] .hover\:text-sky-300:hover {
        color: #1d4ed8 !important;
      }

      html[data-theme="light"] .hover\:bg-slate-900\/30:hover {
        background-color: rgba(226, 232, 240, 0.7) !important;
      }

      html[data-theme="light"] .col-highlight {
        background-color: rgba(226, 232, 240, 0.85);
      }
      html[data-theme="light"] .row-highlight {
        background-color: rgba(203, 213, 225, 0.55);
      }
      html[data-theme="light"] .cell-highlight {
        color: #0f172a;
      }
      html[data-theme="light"] .head-highlight {
        color: #1d4ed8;
      }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <main class="mx-auto max-w-6xl px-6 py-10">
      <header class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="text-2xl font-semibold tracking-tight">Typing conformance</h1>
          <p id="subtitle" class="mt-1 text-sm text-slate-300"></p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <a
            class="text-sm text-sky-300 hover:text-sky-200 underline"
            href="./typing_conformance.json"
          >
            Data (JSON)
          </a>
          <button
            id="toggleMarkers"
            class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-slate-100 ring-1 ring-slate-700 hover:bg-slate-750"
          >
            Toggle markers
          </button>
          <button
            id="toggleTheme"
            class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-slate-100 ring-1 ring-slate-700 hover:bg-slate-750"
            aria-label="Toggle light/dark theme"
          >
            Theme: Auto
          </button>
        </div>
      </header>

      <section class="mt-8 grid gap-6">
        <div class="rounded-2xl bg-slate-900/40 p-4 ring-1 ring-slate-800">
          <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-sm text-slate-200">Precision / Recall / F1</div>
              <details class="mt-2 text-xs text-slate-400">
                <summary class="has-tooltip inline-flex items-center gap-2 text-slate-300">
                  What do these metrics mean?
                  <span class="tooltip-icon" title="Tap to expand.">ⓘ</span>
                </summary>
                <div class="mt-2 space-y-1 text-slate-400">
                  <p>
                    <span class="font-semibold text-slate-200">Precision</span>: when <code>ty</code>
                    reports an error, how often is it an expected error in the conformance suite?
                  </p>
                  <p>
                    <span class="font-semibold text-slate-200">Recall</span>: of all expected errors
                    in the conformance suite, how many did <code>ty</code> actually catch?
                  </p>
                  <p>
                    <span class="font-semibold text-slate-200">F1 score</span>: a single score that
                    balances precision and recall (their harmonic mean).
                  </p>
                  <p class="text-slate-500">
                    Note: these are conformance-suite metrics, not “ground truth” for all Python
                    code.
                  </p>
                </div>
              </details>
            </div>
            <div class="text-xs text-slate-400">
              Tip: drag to zoom, double-click to reset • click a point to open the commit
            </div>
          </div>
          <div id="chart_metrics" style="height: 440px"></div>
        </div>

        <div class="rounded-2xl bg-slate-900/40 p-4 ring-1 ring-slate-800">
          <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
            <div class="text-sm text-slate-200">ty check runtime (seconds)</div>
            <div class="text-xs text-slate-400">Click a point to open the commit</div>
          </div>
          <div id="chart_runtime" style="height: 320px"></div>
        </div>

        <div class="rounded-2xl bg-slate-900/40 p-4 ring-1 ring-slate-800">
          <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-sm text-slate-200">Breakdown by test group</div>
              <div id="breakdown_meta" class="mt-1 text-xs text-slate-400"></div>
              <details class="mt-2 text-xs text-slate-400">
                <summary class="has-tooltip inline-flex items-center gap-2 text-slate-300">
                  What do the counts mean?
                  <span class="tooltip-icon" title="Tap to expand.">ⓘ</span>
                </summary>
                <div class="mt-2 space-y-1 text-slate-400">
                  <p>
                    <span class="font-semibold text-slate-200">True positives</span>: expected errors
                    that received a diagnostic (counted as diagnostics, not just locations).
                  </p>
                  <p>
                    <span class="font-semibold text-slate-200">False positives</span>: diagnostics
                    that were not expected by the conformance suite.
                  </p>
                  <p>
                    <span class="font-semibold text-slate-200">False negatives</span>: expected error
                    locations that did not receive any diagnostic.
                  </p>
                  <p>
                    <span class="font-semibold text-slate-200">Total</span>: total diagnostics emitted
                    for this group.
                  </p>
                  <p>
                    <span class="font-semibold text-slate-200">Files</span>: number of conformance
                    test files in the group.
                  </p>
                  <p class="text-slate-500">
                    Note: these are conformance-suite metrics, not “ground truth” for all Python
                    code.
                  </p>
                </div>
              </details>
            </div>
            <div class="flex flex-wrap items-center gap-3">
              <a
                class="text-sm text-sky-300 hover:text-sky-200 underline"
                href="./breakdown_latest.json"
              >
                Breakdown (JSON)
              </a>
              <input
                id="breakdownFilter"
                class="w-56 rounded-lg bg-slate-950/50 px-3 py-1.5 text-sm text-slate-100 ring-1 ring-slate-700 placeholder:text-slate-500"
                placeholder="Filter groups…"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-slate-300">
                <tr class="border-b border-slate-800">
                  <th
                    data-col="0"
                    class="py-2 pr-4 text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="Test group (from typing conformance suite)">Group</span>
                  </th>
                  <th
                    data-col="1"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="F1 score (harmonic mean of precision and recall)">F1 score</span>
                  </th>
                  <th
                    data-col="2"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="Precision (TP / (TP + FP))">Precision</span>
                  </th>
                  <th
                    data-col="3"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="Recall (TP / (TP + FN))">Recall</span>
                  </th>
                  <th
                    data-col="4"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="True positives (TP)">True positives</span>
                  </th>
                  <th
                    data-col="5"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="False positives (FP)">False positives</span>
                  </th>
                  <th
                    data-col="6"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="False negatives (FN)">False negatives</span>
                  </th>
                  <th
                    data-col="7"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="Total emitted diagnostics">Total</span>
                  </th>
                  <th
                    data-col="8"
                    class="py-2 pr-4 text-right text-xs font-semibold uppercase tracking-wide text-slate-300 transition-colors"
                  >
                    <span class="has-tooltip" title="Number of test files in this group">Files</span>
                  </th>
                </tr>
              </thead>
              <tbody id="breakdownBody" class="text-slate-200"></tbody>
            </table>
          </div>
          <div id="breakdown_empty" class="mt-3 hidden text-sm text-slate-400"></div>
        </div>
      </section>

      <footer class="mt-10 text-xs text-slate-500">
        Generated from <code class="text-slate-400">typing_conformance.json</code>. Charts are
        interactive via Plotly.
      </footer>
    </main>

    <script>
      const DATA_URL = "./typing_conformance.json";
      const BREAKDOWN_URL = "./breakdown_latest.json";
      const COMMIT_REPO_URL = "https://github.com/astral-sh/ruff";

      function getPreferredTheme() {
        const stored = localStorage.getItem("theme");
        if (stored === "light" || stored === "dark") return stored;
        return window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches
          ? "light"
          : "dark";
      }

      function setTheme(theme, { persist } = { persist: true }) {
        document.documentElement.dataset.theme = theme;
        if (persist) {
          localStorage.setItem("theme", theme);
        }
        const label = theme === "light" ? "Light" : "Dark";
        const btn = document.getElementById("toggleTheme");
        if (btn) btn.textContent = `Theme: ${label}`;
      }

      function pct(value) {
        return value * 100;
      }

      function fmtPct(value) {
        return `${value.toFixed(2)}%`;
      }

      function baseLayout() {
        const theme = document.documentElement.dataset.theme || "dark";
        const light = theme === "light";
        return {
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          font: { color: light ? "#0f172a" : "#e2e8f0" },
          margin: { l: 55, r: 20, t: 10, b: 40 },
          xaxis: {
            gridcolor: light ? "#e2e8f0" : "#1f2937",
            tickcolor: light ? "#cbd5e1" : "#334155",
          },
          yaxis: {
            gridcolor: light ? "#e2e8f0" : "#1f2937",
            tickcolor: light ? "#cbd5e1" : "#334155",
          },
          legend: { orientation: "h", y: 1.13, x: 0 },
        };
      }

      function themeRelayout() {
        const b = baseLayout();
        return {
          "font.color": b.font.color,
          "xaxis.gridcolor": b.xaxis.gridcolor,
          "xaxis.tickcolor": b.xaxis.tickcolor,
          "yaxis.gridcolor": b.yaxis.gridcolor,
          "yaxis.tickcolor": b.yaxis.tickcolor,
        };
      }

      function hoverPct(label) {
        return (
          `<b>${label}</b>: %{y:.2f}%<br>` +
          `date: %{x}<br>` +
          `commit: %{customdata}<extra></extra>`
        );
      }

      function computePercentRange(seriesList, { pad = 2 } = {}) {
        const values = seriesList
          .flat()
          .map((v) => Number(v))
          .filter((v) => Number.isFinite(v));
        if (values.length === 0) return [0, 100];

        const min = Math.min(...values);
        const max = Math.max(...values);
        let lo = Math.max(0, min - pad);
        let hi = Math.min(100, max + pad);

        // Avoid a comically tight window.
        if (hi - lo < 5) {
          const mid = (hi + lo) / 2;
          lo = Math.max(0, mid - 2.5);
          hi = Math.min(100, mid + 2.5);
        }

        // Round to 0.5% increments for nicer ticks.
        lo = Math.floor(lo * 2) / 2;
        hi = Math.ceil(hi * 2) / 2;

        return [lo, hi];
      }

      async function main() {
        // Theme
        setTheme(getPreferredTheme(), { persist: false });
        const themeButton = document.getElementById("toggleTheme");
        if (themeButton) {
          themeButton.addEventListener("click", async () => {
            const cur = document.documentElement.dataset.theme || "dark";
            const next = cur === "dark" ? "light" : "dark";
            setTheme(next, { persist: true });
            try {
              await Plotly.relayout("chart_metrics", themeRelayout());
              await Plotly.relayout("chart_runtime", themeRelayout());
            } catch {
              // Charts may not be mounted yet.
            }
          });
        }

        const response = await fetch(DATA_URL, { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`Failed to load ${DATA_URL}: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();

        const dates = data.map((d) => d.sample_date);
        const sha10 = data.map((d) => (d.commit_sha ?? "").slice(0, 10));
        const commitUrl = data.map((d) =>
          d.commit_sha ? `${COMMIT_REPO_URL}/commit/${d.commit_sha}` : null
        );

        const precision = data.map((d) => pct(d.metrics.precision));
        const recall = data.map((d) => pct(d.metrics.recall));
        const f1 = data.map((d) => pct(d.metrics.f1));
        const runSeconds = data.map((d) => d.run_seconds);

        const suite = (data[0]?.conformance_suite_revision ?? "").slice(0, 10);
        const first = dates[0];
        const last = dates[dates.length - 1];
        const latest = data[data.length - 1];
        document.getElementById("subtitle").textContent =
          `${first} → ${last} • ${data.length} samples • suite ${suite}… • latest F1 ${fmtPct(
            pct(latest.metrics.f1)
          )}`;

        let showMarkers = false;
        const mode = () => (showMarkers ? "lines+markers" : "lines");

        const metricsTraces = [
          {
            x: dates,
            y: precision,
            name: "Precision",
            mode: mode(),
            customdata: sha10,
            hovertemplate: hoverPct("Precision"),
            line: { width: 2 },
          },
          {
            x: dates,
            y: recall,
            name: "Recall",
            mode: mode(),
            customdata: sha10,
            hovertemplate: hoverPct("Recall"),
            line: { width: 2 },
          },
          {
            x: dates,
            y: f1,
            name: "F1",
            mode: mode(),
            customdata: sha10,
            hovertemplate: hoverPct("F1"),
            line: { width: 2 },
          },
        ];

        const metricsLayout = {
          ...baseLayout(),
          yaxis: {
            ...baseLayout().yaxis,
            ticksuffix: "%",
            range: computePercentRange([precision, recall, f1]),
          },
        };

        await Plotly.newPlot("chart_metrics", metricsTraces, metricsLayout, { responsive: true });

        const runtimeTraces = [
          {
            x: dates,
            y: runSeconds,
            name: "ty check",
            mode: "lines+markers",
            customdata: sha10,
            hovertemplate:
              "<b>ty check</b>: %{y:.2f}s<br>date: %{x}<br>commit: %{customdata}<extra></extra>",
            line: { width: 2 },
          },
        ];
        const runtimeLayout = {
          ...baseLayout(),
          yaxis: { ...baseLayout().yaxis, title: "seconds" },
        };
        await Plotly.newPlot("chart_runtime", runtimeTraces, runtimeLayout, { responsive: true });

        const openCommit = (ev) => {
          const i = ev.points[0].pointIndex;
          const url = commitUrl[i];
          if (url) window.open(url, "_blank", "noopener,noreferrer");
        };
        document.getElementById("chart_metrics").on("plotly_click", openCommit);
        document.getElementById("chart_runtime").on("plotly_click", openCommit);

        document.getElementById("toggleMarkers").addEventListener("click", async () => {
          showMarkers = !showMarkers;
          await Plotly.restyle("chart_metrics", { mode: mode() });
        });

        // Breakdown table (optional)
        try {
          const breakdownResponse = await fetch(BREAKDOWN_URL, { cache: "no-store" });
          if (!breakdownResponse.ok) {
            throw new Error(`${breakdownResponse.status} ${breakdownResponse.statusText}`);
          }
          const breakdown = await breakdownResponse.json();

          const meta = document.getElementById("breakdown_meta");
          const suite = (breakdown.conformance_suite_revision ?? "").slice(0, 10);
          const sha = (breakdown.commit_sha ?? "").slice(0, 10);
          meta.textContent = `${breakdown.sample_date} • commit ${sha}… • suite ${suite}… • ty check ${breakdown.run_seconds.toFixed(
            2
          )}s`;

          const rows = breakdown.groups ?? [];
          const tbody = document.getElementById("breakdownBody");
          const empty = document.getElementById("breakdown_empty");
          const filter = document.getElementById("breakdownFilter");

          const fmtPct = (x, denom) => (denom > 0 ? `${(x * 100).toFixed(2)}%` : "—");
          const fmtInt = (x) => (x ?? 0).toLocaleString();

          const COL_CLASS = "col-highlight";
          const ROW_CLASS = "row-highlight";
          const HEAD_CLASS = "head-highlight";
          const CELL_CLASS = "cell-highlight";

          const clearHoverState = () => {
            const table = tbody.closest("table");
            if (!table) return;
            table.querySelectorAll("." + COL_CLASS).forEach((el) => el.classList.remove(COL_CLASS));
            table.querySelectorAll("." + HEAD_CLASS).forEach((el) => el.classList.remove(HEAD_CLASS));
            table.querySelectorAll("." + ROW_CLASS).forEach((el) => el.classList.remove(ROW_CLASS));
            table.querySelectorAll("." + CELL_CLASS).forEach((el) => el.classList.remove(CELL_CLASS));
          };

          const ensureHoverHandlers = (() => {
            let wired = false;
            return () => {
              if (wired) return;
              wired = true;

              const table = tbody.closest("table");
              if (!table) return;

              let lastCol = null;
              let lastRow = null;
              let lastCell = null;

              const applyCol = (col) => {
                if (col === null) return;
                tbody
                  .querySelectorAll(`td[data-col="${col}"]`)
                  .forEach((el) => el.classList.add(COL_CLASS));
                table.querySelectorAll(`thead [data-col="${col}"]`).forEach((el) => el.classList.add(HEAD_CLASS));
              };

              const clearCol = (col) => {
                if (col === null) return;
                tbody
                  .querySelectorAll(`td[data-col="${col}"]`)
                  .forEach((el) => el.classList.remove(COL_CLASS));
                table.querySelectorAll(`thead [data-col="${col}"]`).forEach((el) => el.classList.remove(HEAD_CLASS));
              };

              tbody.addEventListener("mousemove", (ev) => {
                const cell = ev.target.closest("td");
                if (!cell) return;

                const col = cell.getAttribute("data-col");
                const row = cell.parentElement;

                if (lastCell && lastCell !== cell) lastCell.classList.remove(CELL_CLASS);
                cell.classList.add(CELL_CLASS);
                lastCell = cell;

                if (lastRow && lastRow !== row) lastRow.classList.remove(ROW_CLASS);
                row.classList.add(ROW_CLASS);
                lastRow = row;

                if (lastCol !== col) {
                  clearCol(lastCol);
                  applyCol(col);
                  lastCol = col;
                }
              });

              tbody.addEventListener("mouseleave", () => {
                if (lastCell) lastCell.classList.remove(CELL_CLASS);
                if (lastRow) lastRow.classList.remove(ROW_CLASS);
                clearCol(lastCol);
                lastCol = null;
                lastRow = null;
                lastCell = null;
              });
            };
          })();

          function render() {
            const q = (filter.value ?? "").trim().toLowerCase();
            const filtered = rows.filter((r) => {
              const g = (r.group ?? "").toLowerCase();
              const n = (r.name ?? "").toLowerCase();
              return !q || g.includes(q) || n.includes(q);
            });

            clearHoverState();
            tbody.innerHTML = "";
            for (const r of filtered) {
              const m = r.metrics;
              const groupLabel = r.name ? `${r.group} — ${r.name}` : r.group;
              const linkStart = r.href ? `<a class="text-sky-300 hover:text-sky-200 underline" href="${r.href}" target="_blank" rel="noopener noreferrer">` : "";
              const linkEnd = r.href ? `</a>` : "";
              const f1Denom = (2 * m.true_positives) + m.false_positives + m.false_negatives;

              const tr = document.createElement("tr");
              tr.className = "border-b border-slate-900/60 transition-colors hover:bg-slate-900/30";
              tr.innerHTML = `
                <td data-col="0" class="py-2 pr-4 whitespace-nowrap transition-colors">${linkStart}${groupLabel}${linkEnd}</td>
                <td data-col="1" class="py-2 pr-4 text-right font-medium tabular-nums transition-colors">${fmtPct(m.f1, f1Denom)}</td>
                <td data-col="2" class="py-2 pr-4 text-right tabular-nums transition-colors">${fmtPct(m.precision, m.precision_denom)}</td>
                <td data-col="3" class="py-2 pr-4 text-right tabular-nums transition-colors">${fmtPct(m.recall, m.recall_denom)}</td>
                <td data-col="4" class="py-2 pr-4 text-right tabular-nums transition-colors">${fmtInt(m.true_positives)}</td>
                <td data-col="5" class="py-2 pr-4 text-right tabular-nums transition-colors">${fmtInt(m.false_positives)}</td>
                <td data-col="6" class="py-2 pr-4 text-right tabular-nums transition-colors">${fmtInt(m.false_negatives)}</td>
                <td data-col="7" class="py-2 pr-4 text-right tabular-nums transition-colors">${fmtInt(m.total_diagnostics)}</td>
                <td data-col="8" class="py-2 pr-4 text-right tabular-nums transition-colors">${fmtInt(r.test_files)}</td>
              `;
              tbody.appendChild(tr);
            }

            if (filtered.length === 0) {
              empty.classList.remove("hidden");
              empty.textContent = "No groups match the filter.";
            } else {
              empty.classList.add("hidden");
            }

            ensureHoverHandlers();
          }

          filter.addEventListener("input", render);
          render();
        } catch (e) {
          const meta = document.getElementById("breakdown_meta");
          meta.textContent = `No breakdown yet (${String(e)}). Add ${BREAKDOWN_URL} to enable this table.`;
        }
      }

      main().catch((err) => {
        console.error(err);
        document.getElementById("subtitle").textContent = String(err);
      });
    </script>
  </body>
</html>
