<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Typing conformance</title>
    <meta name="color-scheme" content="dark" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <main class="mx-auto max-w-6xl px-6 py-10">
      <header class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="text-2xl font-semibold tracking-tight">Typing conformance</h1>
          <p id="subtitle" class="mt-1 text-sm text-slate-300"></p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <a
            class="text-sm text-sky-300 hover:text-sky-200 underline"
            href="./typing_conformance.json"
          >
            Data (JSON)
          </a>
          <button
            id="toggleMarkers"
            class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-slate-100 ring-1 ring-slate-700 hover:bg-slate-750"
          >
            Toggle markers
          </button>
        </div>
      </header>

      <section class="mt-8 grid gap-6">
        <div class="rounded-2xl bg-slate-900/40 p-4 ring-1 ring-slate-800">
          <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
            <div class="text-sm text-slate-200">Precision / Recall / F1</div>
            <div class="text-xs text-slate-400">Tip: drag to zoom, double-click to reset</div>
          </div>
          <div id="chart_metrics" style="height: 440px"></div>
        </div>

        <div class="rounded-2xl bg-slate-900/40 p-4 ring-1 ring-slate-800">
          <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
            <div class="text-sm text-slate-200">ty check runtime (seconds)</div>
            <div class="text-xs text-slate-400">Click a point to open the commit</div>
          </div>
          <div id="chart_runtime" style="height: 320px"></div>
        </div>

        <div class="rounded-2xl bg-slate-900/40 p-4 ring-1 ring-slate-800">
          <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-sm text-slate-200">Breakdown by test group</div>
              <div id="breakdown_meta" class="mt-1 text-xs text-slate-400"></div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
              <a
                class="text-sm text-sky-300 hover:text-sky-200 underline"
                href="./breakdown_latest.json"
              >
                Breakdown (JSON)
              </a>
              <input
                id="breakdownFilter"
                class="w-56 rounded-lg bg-slate-950/50 px-3 py-1.5 text-sm text-slate-100 ring-1 ring-slate-700 placeholder:text-slate-500"
                placeholder="Filter groups…"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-slate-300">
                <tr class="border-b border-slate-800">
                  <th class="py-2 pr-4">Group</th>
                  <th class="py-2 pr-4">F1</th>
                  <th class="py-2 pr-4">Precision</th>
                  <th class="py-2 pr-4">Recall</th>
                  <th class="py-2 pr-4">TP</th>
                  <th class="py-2 pr-4">FP</th>
                  <th class="py-2 pr-4">FN</th>
                  <th class="py-2 pr-4">Total</th>
                  <th class="py-2 pr-4">Files</th>
                </tr>
              </thead>
              <tbody id="breakdownBody" class="text-slate-200"></tbody>
            </table>
          </div>
          <div id="breakdown_empty" class="mt-3 hidden text-sm text-slate-400"></div>
        </div>
      </section>

      <footer class="mt-10 text-xs text-slate-500">
        Generated from <code class="text-slate-400">typing_conformance.json</code>. Charts are
        interactive via Plotly.
      </footer>
    </main>

    <script>
      const DATA_URL = "./typing_conformance.json";
      const BREAKDOWN_URL = "./breakdown_latest.json";
      const COMMIT_REPO_URL = "https://github.com/astral-sh/ruff";

      function pct(value) {
        return value * 100;
      }

      function fmtPct(value) {
        return `${value.toFixed(2)}%`;
      }

      function baseLayout() {
        return {
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          font: { color: "#e2e8f0" },
          margin: { l: 55, r: 20, t: 10, b: 40 },
          xaxis: { gridcolor: "#1f2937", tickcolor: "#334155" },
          yaxis: { gridcolor: "#1f2937", tickcolor: "#334155" },
          legend: { orientation: "h", y: 1.13, x: 0 },
        };
      }

      function hoverPct(label) {
        return (
          `<b>${label}</b>: %{y:.2f}%<br>` +
          `date: %{x}<br>` +
          `commit: %{customdata}<extra></extra>`
        );
      }

      async function main() {
        const response = await fetch(DATA_URL, { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`Failed to load ${DATA_URL}: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();

        const dates = data.map((d) => d.sample_date);
        const sha10 = data.map((d) => (d.commit_sha ?? "").slice(0, 10));
        const commitUrl = data.map((d) =>
          d.commit_sha ? `${COMMIT_REPO_URL}/commit/${d.commit_sha}` : null
        );

        const precision = data.map((d) => pct(d.metrics.precision));
        const recall = data.map((d) => pct(d.metrics.recall));
        const f1 = data.map((d) => pct(d.metrics.f1));
        const runSeconds = data.map((d) => d.run_seconds);

        const suite = (data[0]?.conformance_suite_revision ?? "").slice(0, 10);
        const first = dates[0];
        const last = dates[dates.length - 1];
        const latest = data[data.length - 1];
        document.getElementById("subtitle").textContent =
          `${first} → ${last} • ${data.length} samples • suite ${suite}… • latest F1 ${fmtPct(
            pct(latest.metrics.f1)
          )}`;

        let showMarkers = false;
        const mode = () => (showMarkers ? "lines+markers" : "lines");

        const metricsTraces = [
          {
            x: dates,
            y: precision,
            name: "Precision",
            mode: mode(),
            customdata: sha10,
            hovertemplate: hoverPct("Precision"),
            line: { width: 2 },
          },
          {
            x: dates,
            y: recall,
            name: "Recall",
            mode: mode(),
            customdata: sha10,
            hovertemplate: hoverPct("Recall"),
            line: { width: 2 },
          },
          {
            x: dates,
            y: f1,
            name: "F1",
            mode: mode(),
            customdata: sha10,
            hovertemplate: hoverPct("F1"),
            line: { width: 2 },
          },
        ];

        const metricsLayout = {
          ...baseLayout(),
          yaxis: { ...baseLayout().yaxis, ticksuffix: "%", rangemode: "tozero" },
        };

        await Plotly.newPlot("chart_metrics", metricsTraces, metricsLayout, { responsive: true });

        const runtimeTraces = [
          {
            x: dates,
            y: runSeconds,
            name: "ty check",
            mode: "lines+markers",
            customdata: sha10,
            hovertemplate:
              "<b>ty check</b>: %{y:.2f}s<br>date: %{x}<br>commit: %{customdata}<extra></extra>",
            line: { width: 2 },
          },
        ];
        const runtimeLayout = { ...baseLayout(), yaxis: { ...baseLayout().yaxis, title: "seconds" } };
        await Plotly.newPlot("chart_runtime", runtimeTraces, runtimeLayout, { responsive: true });

        const openCommit = (ev) => {
          const i = ev.points[0].pointIndex;
          const url = commitUrl[i];
          if (url) window.open(url, "_blank", "noopener,noreferrer");
        };
        document.getElementById("chart_metrics").on("plotly_click", openCommit);
        document.getElementById("chart_runtime").on("plotly_click", openCommit);

        document.getElementById("toggleMarkers").addEventListener("click", async () => {
          showMarkers = !showMarkers;
          await Plotly.restyle("chart_metrics", { mode: mode() });
        });

        // Breakdown table (optional)
        try {
          const breakdownResponse = await fetch(BREAKDOWN_URL, { cache: "no-store" });
          if (!breakdownResponse.ok) {
            throw new Error(`${breakdownResponse.status} ${breakdownResponse.statusText}`);
          }
          const breakdown = await breakdownResponse.json();

          const meta = document.getElementById("breakdown_meta");
          const suite = (breakdown.conformance_suite_revision ?? "").slice(0, 10);
          const sha = (breakdown.commit_sha ?? "").slice(0, 10);
          meta.textContent = `${breakdown.sample_date} • commit ${sha}… • suite ${suite}… • ty check ${breakdown.run_seconds.toFixed(
            2
          )}s`;

          const rows = breakdown.groups ?? [];
          const tbody = document.getElementById("breakdownBody");
          const empty = document.getElementById("breakdown_empty");
          const filter = document.getElementById("breakdownFilter");

          const fmtPct = (x, denom) => (denom > 0 ? `${(x * 100).toFixed(2)}%` : "—");
          const fmtNum = (x) => String(x ?? 0);

          function render() {
            const q = (filter.value ?? "").trim().toLowerCase();
            const filtered = rows.filter((r) => {
              const g = (r.group ?? "").toLowerCase();
              const n = (r.name ?? "").toLowerCase();
              return !q || g.includes(q) || n.includes(q);
            });

            tbody.innerHTML = "";
            for (const r of filtered) {
              const m = r.metrics;
              const groupLabel = r.name ? `${r.group} — ${r.name}` : r.group;
              const linkStart = r.href ? `<a class="text-sky-300 hover:text-sky-200 underline" href="${r.href}" target="_blank" rel="noopener noreferrer">` : "";
              const linkEnd = r.href ? `</a>` : "";

              const tr = document.createElement("tr");
              tr.className = "border-b border-slate-900/60";
              tr.innerHTML = `
                <td class="py-2 pr-4 whitespace-nowrap">${linkStart}${groupLabel}${linkEnd}</td>
                <td class="py-2 pr-4 font-medium">${fmtPct(m.f1, m.precision_denom + m.false_negatives)}</td>
                <td class="py-2 pr-4">${fmtPct(m.precision, m.precision_denom)}</td>
                <td class="py-2 pr-4">${fmtPct(m.recall, m.recall_denom)}</td>
                <td class="py-2 pr-4">${fmtNum(m.true_positives)}</td>
                <td class="py-2 pr-4">${fmtNum(m.false_positives)}</td>
                <td class="py-2 pr-4">${fmtNum(m.false_negatives)}</td>
                <td class="py-2 pr-4">${fmtNum(m.total_diagnostics)}</td>
                <td class="py-2 pr-4">${fmtNum(r.test_files)}</td>
              `;
              tbody.appendChild(tr);
            }

            if (filtered.length === 0) {
              empty.classList.remove("hidden");
              empty.textContent = "No groups match the filter.";
            } else {
              empty.classList.add("hidden");
            }
          }

          filter.addEventListener("input", render);
          render();
        } catch (e) {
          const meta = document.getElementById("breakdown_meta");
          meta.textContent = `No breakdown yet (${String(e)}). Add ${BREAKDOWN_URL} to enable this table.`;
        }
      }

      main().catch((err) => {
        console.error(err);
        document.getElementById("subtitle").textContent = String(err);
      });
    </script>
  </body>
</html>
